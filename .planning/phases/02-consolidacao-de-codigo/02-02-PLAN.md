---
phase: 02-consolidacao-de-codigo
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tests/test_runtime.sh
  - tests/test_core.sh
  - tests/test_helpers.sh
  - lib/plugin.sh
  - install.sh
  - examples/example_workflow.sh
  - lib/runtime.sh
  - lib/core.sh
autonomous: true

must_haves:
  truths:
    - "All callers use core_ prefixed function names"
    - "test_runtime.sh sources core.sh only and tests core_ functions"
    - "runtime.sh is deleted from lib/"
    - "make test passes with no failures"
  artifacts:
    - path: "tests/test_runtime.sh"
      provides: "Runtime tests sourcing core.sh with core_ prefix"
      contains: "core_need_cmd"
    - path: "lib/plugin.sh"
      provides: "Plugin system using core_ functions"
      contains: "core_need_cmd"
  key_links:
    - from: "tests/test_runtime.sh"
      to: "lib/core.sh"
      via: "source statement"
      pattern: 'source.*core\.sh'
    - from: "lib/plugin.sh"
      to: "lib/core.sh"
      via: "core_ function calls"
      pattern: "core_need_cmd"
---

<objective>
Update all callers to use core_ prefix and delete runtime.sh

Purpose: Complete the consolidation by updating ALL callers to use the new core_ prefixed function names and removing the now-redundant runtime.sh
Output: All callers use core_ prefix, tests pass with core.sh as single source, runtime.sh deleted
</objective>

<execution_context>
@/home/marlonsc/.claude/get-shit-done/workflows/execute-plan.md
@/home/marlonsc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-consolidacao-de-codigo/02-CONTEXT.md
@.planning/phases/02-consolidacao-de-codigo/02-01-SUMMARY.md
@tests/test_runtime.sh
@tests/test_core.sh
@tests/test_helpers.sh
@lib/plugin.sh
@install.sh
@examples/example_workflow.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all callers to use core_ prefix</name>
  <files>lib/plugin.sh, install.sh, examples/example_workflow.sh, tests/test_helpers.sh</files>
  <action>
Update ALL files that call runtime functions to use the new core_ prefix. Per CONTEXT.md decision: "Rename ALL calls to use core_ prefix across all scripts".

**Find all callers first:**
```bash
grep -rn '\b\(need_cmd\|need_cmds\|assert_file\|assert_dir\|assert_nonempty\|assert_var\|spin\|retry\|timeout_cmd\|run_silent\|run_or_die\)\b' lib/*.sh tests/*.sh examples/*.sh install.sh --include="*.sh" 2>/dev/null | grep -v runtime.sh | grep -v "^#"
```

**Rename pattern for each file:**

1. **lib/plugin.sh** - Replace:
   - `need_cmd` → `core_need_cmd`
   - `spin` → `core_spin`
   - Any other runtime functions called

2. **install.sh** - Replace:
   - All runtime function calls with core_ prefix

3. **examples/example_workflow.sh** - Replace:
   - All runtime function calls with core_ prefix

4. **tests/test_helpers.sh** - Replace:
   - All runtime function calls with core_ prefix

**Mapping reference:**
| Old Name | New Name |
|----------|----------|
| need_cmd | core_need_cmd |
| need_cmds | core_need_cmds |
| assert_file | core_assert_file |
| assert_dir | core_assert_dir |
| assert_nonempty | core_assert_nonempty |
| assert_var | core_assert_var |
| spin | core_spin |
| retry | core_retry |
| timeout_cmd | core_timeout_cmd |
| run_silent | core_run_silent |
| run_or_die | core_run_or_die |
  </action>
  <verify>
Run: `grep -rn '\bneed_cmd\b\|\bspin\b\|\bretry\b\|\brun_or_die\b' lib/*.sh tests/*.sh examples/*.sh install.sh --include="*.sh" 2>/dev/null | grep -v runtime.sh | grep -v core_ | grep -v "^#"`
Should return NO results (all calls now use core_ prefix).
  </verify>
  <done>
All callers updated to use core_ prefixed function names.
No unprefixed function calls remain outside runtime.sh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test_runtime.sh to test core_ functions</name>
  <files>tests/test_runtime.sh</files>
  <action>
Edit tests/test_runtime.sh:

1. Change the source lines (around line 16-17):
   FROM:
   ```bash
   source "${LIB_DIR}/core.sh"
   source "${LIB_DIR}/runtime.sh"
   ```
   TO:
   ```bash
   source "${LIB_DIR}/core.sh"
   # runtime.sh merged into core.sh - all functions available via core.sh with core_ prefix
   ```

2. Update the first test name (around line 20):
   FROM: `run_test "runtime.sh loads" "true"`
   TO: `run_test "core.sh provides runtime functions with core_ prefix" "true"`

3. Update test file header comment (line 3):
   FROM: `# test_runtime.sh - Tests for lib/runtime.sh`
   TO: `# test_runtime.sh - Tests for runtime utilities in lib/core.sh (core_ prefix)`

4. Update echo message (around line 8):
   FROM: `echo "Testing runtime.sh..."`
   TO: `echo "Testing runtime utilities (core_ prefix in core.sh)..."`

5. **CRITICAL: Update ALL function calls in tests to use core_ prefix:**
   - `need_cmd bash` → `core_need_cmd bash`
   - `assert_file` → `core_assert_file`
   - `assert_dir` → `core_assert_dir`
   - `assert_nonempty` → `core_assert_nonempty`
   - `spin` → `core_spin`
   - `retry` → `core_retry`
   - `run_or_die` → `core_run_or_die`
   - etc.

Keep all test logic exactly the same - only rename the function calls.
  </action>
  <verify>
Run: `./tests/test_runtime.sh`
All tests should pass with core_ prefixed function calls.
  </verify>
  <done>
test_runtime.sh sources only core.sh.
All tests call core_ prefixed functions.
All runtime function tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Delete runtime.sh and run full test suite</name>
  <files>lib/runtime.sh</files>
  <action>
1. Verify no remaining callers reference runtime.sh directly:
```bash
grep -r "runtime\.sh" lib/*.sh tests/*.sh examples/*.sh install.sh --include="*.sh" 2>/dev/null || echo "No direct references"
```

Expected: Only comments or the file itself should appear (no source statements remaining).

2. Verify no unprefixed function calls remain:
```bash
grep -rn '\bneed_cmd\b\|\bspin\b\|\bretry\b' lib/*.sh tests/*.sh examples/*.sh install.sh 2>/dev/null | grep -v runtime.sh | grep -v core_ | grep -v "^#" | grep -v "function.*need_cmd\|function.*spin\|function.*retry"
```
Expected: No results.

3. Delete lib/runtime.sh:
```bash
rm lib/runtime.sh
```

4. Run the complete test suite to validate consolidation:
```bash
cd /home/marlonsc/dcx && make test
```

Expected: All tests pass.
  </action>
  <verify>
`ls lib/runtime.sh` returns error (file not found).
`make test` exits with code 0.
All test files report success.
  </verify>
  <done>
lib/runtime.sh no longer exists.
No broken references remain.
Full test suite passes.
Consolidation complete and validated.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `ls lib/runtime.sh 2>&1` - should show "No such file"
2. `./tests/test_runtime.sh` - all tests pass with core_ prefix
3. `./tests/test_core.sh` - all tests pass
4. `make test` - full suite passes
5. `grep -r "source.*runtime\.sh" lib/ tests/ examples/` - no results
6. `grep -rn 'need_cmd\|^spin\|^retry' lib/*.sh tests/*.sh | grep -v core_ | grep -v runtime.sh` - no unprefixed calls
</verification>

<success_criteria>
- All callers use core_ prefixed function names
- lib/runtime.sh is deleted
- tests/test_runtime.sh sources core.sh only and tests core_ functions
- All tests in test_runtime.sh pass
- make test passes with 0 failures
- No remaining source statements for runtime.sh
- No remaining unprefixed function calls
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidacao-de-codigo/02-02-SUMMARY.md`
</output>
