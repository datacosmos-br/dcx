---
phase: 02-consolidacao-de-codigo
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/dcx/platform.go
autonomous: true

must_haves:
  truths:
    - "_dc_find_binary supports Oracle tools (sqlplus, rman, expdp, impdp)"
    - "Search order for Oracle binaries: ORACLE_HOME/bin first, then DCX_HOME/bin, then PATH"
    - "oracle_sql.sh uses oracle_core_get_binary for binary discovery"
  artifacts:
    - path: "cmd/dcx/platform.go"
      provides: "Binary discovery with ORACLE_HOME/bin support"
      contains: "ORACLE_HOME"
  key_links:
    - from: "_dc_find_binary"
      to: "ORACLE_HOME/bin"
      via: "Go binary find command"
      pattern: "ORACLE_HOME"
---

<objective>
Verify and enhance binary discovery for Oracle tools

Purpose: Ensure _dc_find_binary (via Go binary) supports the search order specified in CONTEXT.md: ORACLE_HOME/bin first for Oracle tools (sqlplus, rman, expdp, impdp), then DCX_HOME/bin, then PATH. Also verify oracle_sql.sh helper extraction is complete per Task 2.2.
Output: Binary discovery supports Oracle tools with correct search order
</objective>

<execution_context>
@/home/marlonsc/.claude/get-shit-done/workflows/execute-plan.md
@/home/marlonsc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-consolidacao-de-codigo/02-CONTEXT.md
@cmd/dcx/platform.go
@lib/core.sh
@dcx-oracle/lib/oracle_sql.sh
@dcx-oracle/lib/oracle_core.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify oracle_sql.sh helper extraction status</name>
  <files>dcx-oracle/lib/oracle_sql.sh, dcx-oracle/lib/oracle_core.sh</files>
  <action>
Verify the status of ROADMAP.md Task 2.2 "Extrair helpers oracle_sql.sh":

1. Check current oracle_sql.sh optimization level:
```bash
wc -l dcx-oracle/lib/oracle_sql.sh
grep -c "^[a-z_]*() {" dcx-oracle/lib/oracle_sql.sh
head -30 dcx-oracle/lib/oracle_sql.sh | grep -i "optim\|reduc"
```

2. Verify the consolidation is already done (per file header claiming 36% reduction):
   - Check that base functions exist: `_sql_query_base`, `_sql_sysdba_base`, `_sql_spool_base`
   - Check that thin wrappers delegate to bases

3. Verify oracle_sql.sh uses oracle_core_get_binary() for binary discovery (not direct command -v):
```bash
grep -n "command -v\|which " dcx-oracle/lib/oracle_sql.sh | grep -v "^#"
grep -n "oracle_core_get_binary\|oracle_sql_get_binary" dcx-oracle/lib/oracle_sql.sh | head -5
```

Expected: oracle_sql.sh should use oracle_core_get_binary or oracle_sql_get_binary (which wraps oracle_core_get_binary), NOT raw command -v.

4. If any direct `command -v` usage for Oracle binaries found, update to use oracle_core_get_binary.

Per CONTEXT.md: "Extract BOTH execution wrappers and result parsing helpers" - verify parsing utilities (Section 8) exist and are DRY.
  </action>
  <verify>
Run: `grep -c "_sql_.*_base\(\)" dcx-oracle/lib/oracle_sql.sh`
Expected: 3+ base functions (query, sysdba, spool)

Run: `grep -c "oracle_core_get_binary\|oracle_sql_get_binary" dcx-oracle/lib/oracle_sql.sh`
Expected: Binary discovery via helper function (not raw command -v for Oracle tools)
  </verify>
  <done>
oracle_sql.sh helper extraction verified complete.
Base functions consolidate shared logic.
Binary discovery uses oracle_core_get_binary (not raw command -v).
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and enhance _dc_find_binary for Oracle tools</name>
  <files>cmd/dcx/platform.go</files>
  <action>
Verify the Go binary finder supports Oracle tools per CONTEXT.md requirements:

1. Check current implementation:
```bash
grep -n "ORACLE_HOME" cmd/dcx/platform.go
grep -n "func.*findBinary\|func.*FindBinary" cmd/dcx/platform.go
```

2. Per CONTEXT.md requirements, verify search order:
   - ORACLE_HOME/bin first for Oracle tools (sqlplus, rman, expdp, impdp)
   - DCX_HOME/bin second
   - PATH third

3. Test current behavior:
```bash
# Set up test environment
export ORACLE_HOME=/tmp/test_oracle
mkdir -p "$ORACLE_HOME/bin"
touch "$ORACLE_HOME/bin/sqlplus" && chmod +x "$ORACLE_HOME/bin/sqlplus"

# Test discovery
./bin/dcx binary find sqlplus 2>/dev/null
echo "Exit code: $?"

# Cleanup
rm -rf /tmp/test_oracle
```

4. If ORACLE_HOME/bin is NOT checked first, update cmd/dcx/platform.go:
   - Add check for ORACLE_HOME environment variable
   - For known Oracle tools (sqlplus, rman, expdp, impdp, etc.), check ORACLE_HOME/bin first
   - Fall back to current behavior (DCX_HOME/bin, then PATH) if not found

5. If changes needed, rebuild:
```bash
cd /home/marlonsc/dcx && go build -o bin/dcx-linux-amd64 ./cmd/dcx/
```
  </action>
  <verify>
Run with ORACLE_HOME set:
```bash
export ORACLE_HOME=/tmp/test_oracle
mkdir -p "$ORACLE_HOME/bin"
touch "$ORACLE_HOME/bin/sqlplus" && chmod +x "$ORACLE_HOME/bin/sqlplus"
result=$(./bin/dcx binary find sqlplus 2>/dev/null)
echo "Found: $result"
[[ "$result" == "$ORACLE_HOME/bin/sqlplus" ]] && echo "PASS: ORACLE_HOME/bin searched first" || echo "FAIL: ORACLE_HOME/bin not searched first"
rm -rf /tmp/test_oracle
```
  </verify>
  <done>
_dc_find_binary (via Go) supports Oracle tools.
Search order: ORACLE_HOME/bin first for Oracle tools, then DCX_HOME/bin, then PATH.
Go binary rebuilt if changes made.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. oracle_sql.sh uses oracle_core_get_binary (not raw command -v for Oracle binaries)
2. Base functions exist: `_sql_query_base`, `_sql_sysdba_base`, `_sql_spool_base`
3. `./bin/dcx binary find sqlplus` with ORACLE_HOME set returns ORACLE_HOME/bin/sqlplus
4. Parsing utilities (Section 8) are DRY (minimal duplication)
</verification>

<success_criteria>
- ROADMAP.md Task 2.2 verified complete (oracle_sql.sh already optimized per file header)
- ROADMAP.md Task 2.3 verified: _dc_find_binary supports Oracle binaries with correct search order
- Search order for Oracle tools: ORACLE_HOME/bin > DCX_HOME/bin > PATH
- oracle_sql.sh does not use raw command -v for Oracle binary discovery
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidacao-de-codigo/02-03-SUMMARY.md`
</output>
