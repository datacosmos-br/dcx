---
phase: 03-refatoracao-de-testes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_helpers.sh
autonomous: true

must_haves:
  truths:
    - "test_helpers.sh provides describe() for grouping tests"
    - "test_helpers.sh provides assert_match() for regex assertions"
    - "test_helpers.sh auto-sources lib/core.sh"
    - "Tests display per-file timing information"
  artifacts:
    - path: "tests/test_helpers.sh"
      provides: "Unified test framework with describe blocks and timing"
      contains: "describe()"
      min_lines: 180
  key_links:
    - from: "tests/test_helpers.sh"
      to: "lib/core.sh"
      via: "source statement"
      pattern: "source.*lib/core\\.sh"
---

<objective>
Enhance test_helpers.sh to be the unified test framework.

Purpose: Create the foundation for consistent testing patterns across all test files. This enables describe blocks (Jest/RSpec-style grouping), adds missing assertions, auto-sources lib/core.sh to reduce boilerplate, and adds per-file timing for performance visibility.

Output: Enhanced test_helpers.sh ready for test file conversion.
</objective>

<execution_context>
@/home/marlonsc/.claude/get-shit-done/workflows/execute-plan.md
@/home/marlonsc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-refatoracao-de-testes/03-CONTEXT.md
@tests/test_helpers.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance test_helpers.sh with describe blocks and auto-sourcing</name>
  <files>tests/test_helpers.sh</files>
  <action>
Enhance test_helpers.sh with the following additions:

1. **Auto-source lib/core.sh** at the top (after path setup):
   - Source lib/core.sh so tests don't need to source it individually
   - Add guard to prevent double-loading

2. **Add describe() block function** for test grouping:
   ```bash
   describe() {
       local name="$1"
       shift
       echo ""
       echo "${BOLD}$name${NC}"
       "$@"
   }
   ```
   - Takes a description string and a function/commands to run
   - Prints section header with the description
   - Runs the contained tests

3. **Add assert_match() function** for regex assertions:
   ```bash
   assert_match() {
       local pattern="$1"
       local actual="$2"
       local msg="${3:-should match pattern}"
       TESTS_RUN=$((TESTS_RUN + 1))
       if [[ "$actual" =~ $pattern ]]; then
           test_pass "$msg"
       else
           test_fail "$msg (pattern: '$pattern', got: '$actual')"
       fi
   }
   ```

4. **Add per-file timing** by capturing start time at source and reporting in test_summary():
   - Capture `_TEST_START_TIME` at the top
   - In test_summary(), calculate and display elapsed time
   - Format: "Elapsed: X.XXs"

5. **Add BOLD color constant** for describe headers:
   ```bash
   BOLD='\033[1m'
   ```
   Add to the color detection block (both terminal and non-terminal cases).

Keep all existing functions (run_test, assert_eq, assert_ne, assert_contains, assert_true, assert_false, assert_file, assert_dir, test_setup, test_summary).

Do NOT change the external API - existing tests must still work.
  </action>
  <verify>
Run syntax check: `bash -n tests/test_helpers.sh`
Verify describe function exists: `grep -q "^describe()" tests/test_helpers.sh`
Verify assert_match exists: `grep -q "assert_match()" tests/test_helpers.sh`
Verify core.sh sourcing: `grep -q "source.*lib/core.sh" tests/test_helpers.sh`
Verify timing: `grep -q "_TEST_START_TIME" tests/test_helpers.sh`
Run existing tests to confirm backward compatibility: `./tests/run_all_tests.sh`
  </verify>
  <done>
- test_helpers.sh enhanced with describe(), assert_match(), auto-sourcing
- All existing tests pass without modification
- Per-file timing displays in test output
  </done>
</task>

</tasks>

<verification>
1. `bash -n tests/test_helpers.sh` - no syntax errors
2. `./tests/run_all_tests.sh` - all tests pass (212 tests expected)
3. Output shows timing information per file
4. describe() function callable: `source tests/test_helpers.sh && type describe`
</verification>

<success_criteria>
- [ ] test_helpers.sh passes syntax check
- [ ] All 212 existing tests pass
- [ ] describe() function exists and is callable
- [ ] assert_match() function exists and is callable
- [ ] lib/core.sh auto-sourced when test_helpers.sh loaded
- [ ] Per-file timing visible in test_summary output
</success_criteria>

<output>
After completion, create `.planning/phases/03-refatoracao-de-testes/03-01-SUMMARY.md`
</output>
