---
phase: 03-refatoracao-de-testes
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/test_core.sh
  - tests/test_logging.sh
  - tests/test_config.sh
  - tests/test_parallel.sh
  - tests/test_plugin.sh
  - tests/test_runtime.sh
  - tests/test_update.sh
  - tests/test_tools.sh
autonomous: true

must_haves:
  truths:
    - "All test files use describe() blocks for grouping related tests"
    - "No test file directly sources lib/core.sh (test_helpers.sh does it)"
    - "make test passes with 100% success"
    - "Test count is >= 212 (no test loss)"
  artifacts:
    - path: "tests/test_core.sh"
      provides: "Core module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_logging.sh"
      provides: "Logging module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_config.sh"
      provides: "Config module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_parallel.sh"
      provides: "Parallel module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_plugin.sh"
      provides: "Plugin module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_runtime.sh"
      provides: "Runtime utilities tests with describe blocks"
      contains: "describe"
    - path: "tests/test_update.sh"
      provides: "Update module tests with describe blocks"
      contains: "describe"
    - path: "tests/test_tools.sh"
      provides: "Tools tests with describe blocks"
      contains: "describe"
  key_links:
    - from: "tests/test_*.sh"
      to: "tests/test_helpers.sh"
      via: "source statement"
      pattern: "source.*test_helpers\\.sh"
---

<objective>
Convert all test files to use the unified test framework consistently.

Purpose: Apply describe() blocks for logical grouping, remove redundant lib/core.sh sourcing (since test_helpers.sh now auto-sources it), and ensure consistent patterns across all test files. Target: ~38% reduction in test code duplication.

Output: All 8 test files converted to unified pattern, make test passes 100%.
</objective>

<execution_context>
@/home/marlonsc/.claude/get-shit-done/workflows/execute-plan.md
@/home/marlonsc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-refatoracao-de-testes/03-CONTEXT.md
@.planning/phases/03-refatoracao-de-testes/03-01-SUMMARY.md
@tests/test_helpers.sh
@tests/test_core.sh
@tests/test_logging.sh
@tests/test_config.sh
@tests/test_parallel.sh
@tests/test_plugin.sh
@tests/test_runtime.sh
@tests/test_update.sh
@tests/test_tools.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert all test files to unified framework pattern</name>
  <files>
tests/test_core.sh
tests/test_logging.sh
tests/test_config.sh
tests/test_parallel.sh
tests/test_plugin.sh
tests/test_runtime.sh
tests/test_update.sh
tests/test_tools.sh
  </files>
  <action>
Convert each test file following these patterns. Do ALL files in one pass (per CONTEXT.md decision: migrate all at once).

**For each test file:**

1. **Remove redundant lib/core.sh sourcing:**
   - Delete lines like `source "${LIB_DIR}/core.sh"`
   - test_helpers.sh now auto-sources it
   - KEEP module-specific sourcing (e.g., `source "${LIB_DIR}/logging.sh"`)

2. **Remove manual header echo:**
   - Delete lines like `echo "Testing core.sh..."`
   - The describe blocks will provide headers

3. **Group related tests into describe blocks:**
   - Each logical group gets a describe block
   - Pattern: `describe "Group name" test_group_function`
   - Define test functions that contain the related run_test calls

**Conversion pattern example for test_core.sh:**

```bash
#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "${BASH_SOURCE[0]}")/test_helpers.sh"

# Source module under test (core.sh already sourced by test_helpers.sh)
# For core.sh tests, nothing extra needed

test_module_loads() {
    run_test "core.sh loads" "true"
    run_test "_DCX_CORE_LOADED set" "[[ -n \"\${_DCX_CORE_LOADED:-}\" ]]"
    run_test "DCX_VERSION is set" "[[ -n \"\${DCX_VERSION:-}\" ]]"
    run_test "DCX_VERSION is correct" "[[ \"\${DCX_VERSION}\" == \"0.0.1\" ]]"
}

test_core_functions() {
    run_test "dc_init exists" "type dc_init &>/dev/null"
    run_test "dc_require exists" "type dc_require &>/dev/null"
    # ... etc
}

test_initialization() {
    run_test "dc_init succeeds" "dc_init"
    run_test "DCX_INITIALIZED is set" "[[ \"\${DCX_INITIALIZED:-}\" == \"1\" ]]"
    # ... etc
}

# Run test groups
describe "Module Loading" test_module_loads
describe "Core Functions" test_core_functions
describe "Initialization" test_initialization

test_summary
```

**Grouping guidelines per file:**

- **test_core.sh**: Module Loading, Core Functions, Initialization
- **test_logging.sh**: Module Loading, Log Functions, Log Levels, Output Formats, File Logging, Helpers
- **test_config.sh**: Module Loading, Config Functions, Get/Set Operations, Edge Cases
- **test_parallel.sh**: Module Loading, Functions, Parallel Execution, Batch Operations
- **test_plugin.sh**: Module Loading, Plugin Discovery, Plugin Info, Plugin Loading, Plugin Commands
- **test_runtime.sh**: Module Loading, Validators, Utility Functions
- **test_update.sh**: Module Loading, Constants, Version Functions, Platform Detection, Network Tests
- **test_tools.sh**: Binary Tests, Config Commands (keep skip logic if Go binary not found)

**Important:**
- Keep all test assertions unchanged - only reorganize into describe blocks
- Preserve setup/cleanup logic (test_setup, traps, etc.)
- Keep conditional skipping logic (e.g., test_tools.sh Go binary check)
- Do NOT change test behavior, only organization
  </action>
  <verify>
Syntax check all files: `for f in tests/test_*.sh; do bash -n "$f" && echo "OK: $f"; done`
Run full test suite: `./tests/run_all_tests.sh`
Verify describe usage: `grep -l "describe " tests/test_*.sh | wc -l` (should be 8)
Verify no lib/core.sh sourcing in test files: `grep -l 'source.*lib/core\.sh' tests/test_*.sh | grep -v test_helpers.sh | wc -l` (should be 0)
  </verify>
  <done>
- All 8 test files converted to describe block pattern
- No test file directly sources lib/core.sh
- All tests organized into logical describe groups
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate test suite and count</name>
  <files></files>
  <action>
Final validation of the refactored test suite:

1. **Run full test suite:**
   ```bash
   ./tests/run_all_tests.sh
   ```

2. **Capture test count from output:**
   - Look for "Total Tests: XXX" in output
   - Must be >= 212 (baseline count)

3. **Verify no regressions:**
   - All test suites must pass
   - Exit code must be 0

4. **Check line count reduction:**
   ```bash
   wc -l tests/test_*.sh
   ```
   - Compare against baseline of 945 lines
   - Target: ~38% reduction = ~586 lines

5. **Run make test to confirm CI compatibility:**
   ```bash
   make test
   ```

If any test fails:
- Fix the issue immediately
- Re-run until 100% pass
- Document any test adjustments in summary
  </action>
  <verify>
`./tests/run_all_tests.sh` exits with code 0
`make test` exits with code 0
Test count >= 212
  </verify>
  <done>
- make test passes 100%
- Test count >= 212 (no test loss)
- Line count reduction documented
- All test suites passing
  </done>
</task>

</tasks>

<verification>
1. `bash -n tests/test_*.sh` - all files pass syntax check
2. `./tests/run_all_tests.sh` - all suites pass, test count >= 212
3. `make test` - passes (CI compatibility)
4. `grep -l "describe " tests/test_*.sh | wc -l` = 8 (all files use describe)
5. `grep -l 'source.*lib/core\.sh' tests/test_*.sh | grep -v test_helpers.sh` - empty (no direct sourcing)
</verification>

<success_criteria>
- [ ] All 8 test files converted to describe block pattern
- [ ] No test file directly sources lib/core.sh
- [ ] All tests pass (make test exits 0)
- [ ] Test count >= 212
- [ ] Line count reduction achieved (~38% target)
- [ ] Per-file timing visible in output
</success_criteria>

<output>
After completion, create `.planning/phases/03-refatoracao-de-testes/03-02-SUMMARY.md`
</output>
