#!/usr/bin/env bash
#===============================================================================
# dcx - DCX CLI wrapper
#===============================================================================
# Thin shell wrapper that delegates to Go binary for most commands
# and provides shell-specific functionality (plugin loading, etc.)
#===============================================================================

set -euo pipefail

# Determine DC_HOME
if [[ -n "${DC_HOME:-}" ]]; then
    : # Use provided DC_HOME
elif [[ -L "${BASH_SOURCE[0]}" ]]; then
    DC_HOME="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/.." && pwd)"
else
    DC_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
fi
export DC_HOME

# Find Go binary
_dcx_go_binary() {
    local platform
    platform="$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')"

    # 1. Development: binary in same dir as wrapper
    [[ -x "$DC_HOME/bin/dcx-${platform}" ]] && echo "$DC_HOME/bin/dcx-${platform}" && return 0

    # 2. Installed: binary in share/DCX/bin/
    [[ -x "$DC_HOME/share/DCX/bin/dcx-${platform}" ]] && echo "$DC_HOME/share/DCX/bin/dcx-${platform}" && return 0

    # 3. Fallback: symlink dcx-go
    [[ -x "$DC_HOME/bin/dcx-go" ]] && echo "$DC_HOME/bin/dcx-go" && return 0

    return 1
}

DCX_GO=$(_dcx_go_binary 2>/dev/null || echo "")

# Export binary paths (use Go binary if available)
if [[ -n "$DCX_GO" ]]; then
    export GUM=$("$DCX_GO" binary find gum 2>/dev/null || echo "gum")
    export YQ=$("$DCX_GO" binary find yq 2>/dev/null || echo "yq")
    export RG=$("$DCX_GO" binary find rg 2>/dev/null || echo "rg")
    export FD=$("$DCX_GO" binary find fd 2>/dev/null || echo "fd")
    export SD=$("$DCX_GO" binary find sd 2>/dev/null || echo "sd")
    export SG=$("$DCX_GO" binary find sg 2>/dev/null || echo "sg")
fi

#-------------------------------------------------------------------------------
# Shell-specific commands (need shell for sourcing, plugin loading, etc.)
#-------------------------------------------------------------------------------

_dcx_plugin() {
    if [[ -f "$DC_HOME/lib/plugin.sh" ]]; then
        source "$DC_HOME/lib/core.sh" 2>/dev/null || true
        source "$DC_HOME/lib/plugin.sh"
        dc_plugin_cmd "$@"
    else
        echo "Plugin module not available" >&2
        exit 1
    fi
}

_dcx_shell_help() {
    cat << 'EOF'
DCX Shell Commands (require bash):
  plugin      Manage plugins (list, install, remove, load)
  source      Source a DCX library in current shell
  env         Print environment for shell eval

All other commands are handled by the Go binary.
Run 'dcx help' for full command list.
EOF
}

#-------------------------------------------------------------------------------
# Main router
#-------------------------------------------------------------------------------

case "${1:-help}" in
    # Shell-specific commands
    plugin)
        shift
        _dcx_plugin "$@"
        ;;

    source)
        # For sourcing in user scripts: eval "$(dcx source)"
        shift
        echo "source '$DC_HOME/lib/core.sh'"
        for lib in "$@"; do
            echo "core_load $lib"
        done
        ;;

    env)
        # For shell eval: eval "$(dcx env)"
        echo "export DC_HOME='$DC_HOME'"
        echo "export GUM='${GUM:-}'"
        echo "export YQ='${YQ:-}'"
        echo "export RG='${RG:-}'"
        echo "export FD='${FD:-}'"
        echo "export SD='${SD:-}'"
        echo "export SG='${SG:-}'"
        ;;

    shell-help)
        _dcx_shell_help
        ;;

    # Delegate everything else to Go binary
    *)
        if [[ -n "$DCX_GO" ]]; then
            exec "$DCX_GO" "$@"
        else
            echo "ERROR: Go binary not found. Run 'scripts/build.sh' first." >&2
            exit 1
        fi
        ;;
esac
